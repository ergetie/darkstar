# Darkstar Energy Manager: Active Plan

**Vision: From Calculator to Agent**
Darkstar is transitioning from a deterministic optimizer (v1) to an intelligent energy agent (v2). It does not just optimize based on static config; it observes context (Weather, Vacation, Prices), predicts outcomes (Aurora ML), and actively strategizes (Strategy Engine) to maximize efficiency and comfort.

---

## Revision Naming Conventions

| Prefix | Area | Examples |
|--------|------|----------|
| **K** | Kepler (MILP solver) | K1-K19 |
| **E** | Executor | E1 |
| **A** | Aurora (ML) | A25-A29 |
| **H** | History/DB | H1 |
| **O** | Onboarding | O1 |
| **UI** | User Interface | UI1, UI2 |
| **DS** | Design System | DS1 |
| **F** | Fixes/Bugfixes | F1-F6 |
| **DX** | Developer Experience | DX1 |
| **ARC** | Architecture | ARC1 |

---

## ðŸ¤– AI Instructions (Read First)

1.  **Structure:** This file is a **chronological stream**. Newest items are at the **bottom**.
    
2.  **No Reordering:** Never move items. Only update their status or append new items.
    
3.  **Status Protocol:**
    
    -   Update the status tag in the Header: `### [STATUS] Rev ID â€” Title`
        
    -   Allowed Statuses: `[DRAFT]`, `[PLANNED]`, `[IN PROGRESS]`, `[DONE]`, `[PAUSED]`, `[OBSOLETE]`.
        
4.  **New Revisions:** Always use the template below.
    
5.  **Cleanup:** When this file gets too long (>15 completed items), move the oldest `[DONE]` items to `CHANGELOG.md`.
    

### Revision Template


```

### [STATUS] Rev ID â€” Title

**Goal:** Short description of the objective.
**Plan:**

#### Phase 1: 
* [ ] Step 1
* [ ] Step 2

#### Phase 2: 
* [ ] Step 1
* [ ] Step 2

```

---

## ðŸ“œ Revision Stream

*All completed revisions have been moved to [CHANGELOG_PLAN.md](CHANGELOG_PLAN.md).*Â§


### [DONE] Rev UI5 â€” Dashboard Polish & Financials

**Goal:** Transform the Dashboard from a live monitor into a polished financial tool with real-time energy visualization.

---

#### Phase 1: Bug Fixes [DONE]

- [x] **Fix "Now Line" Alignment:** Debug and fix the issue where the "Now line" does not align with the current time/slot (varies between 24h and 48h views).
- [x] **Fix "Cost Reality" Widget:** Restore "Plan Cost" series in the Cost Reality comparison widget.

---

#### Phase 2: Energy Flow Chart [DONE]

- [x] **New Component:** Create an energy flow chart card for the Dashboard.
- [x] Show real-time flow between: PV â†’ Battery â†’ House Load â†’ Grid (import/export).
- [x] Use animated traces and "hubs" like "github.com/flixlix/power-flow-card-plus".
- [x] Follow the design system in `docs/design-system/AI_GUIDELINES.md`.
- [x] **Infrastructure**: Stabilized WebSocket server with `eventlet` in `scripts/dev-backend.sh`.

---

#### Phase 3: Chart Polish [DONE]

- [x] Render `soc_target` as a step-line (not interpolated).
- [x] Refactor "Now Line" to Chart.js Plugin (for Zoom compatibility).
- [x] Implement mouse-wheel zoom for the main power chart.
- [x] Add tooltips for Price series explaining "VAT + Fees" breakdown.
- [ ] Visual Polish (Gradients, Annotations, Thresholds) - **Moved to Rev UI6**.

---

#### Phase 4: Financial Analytics - **Moved to Rev UI6**

---

### [DONE] Rev UI6 â€” Chart Makeover & Financials

**Goal:** Achieve a "Teenage Engineering" aesthetic and complete the financial analytics.

**Brainstorming: Chart Aesthetics**

> [!NOTE]
> Options maximizing "Teenage Engineering" + "OLED" vibes.

*   **Option A: "The Field" (V2)**
    *   *Vibe:* OP-1 Field / TX-6. Smooth, tactile, high-fidelity.
    *   *Grid:* **Fixed**: Real CSS Dot Grid (1px dots, 24px spacing).
    *   *Lines:* Soft 3px stroke with bloom/shadow.
    *   *Fill:* Vertical gradient (Color -> Transparent).

*   **Option B: "The OLED" (New)**
    *   *Vibe:* High-end Audio Gear / Cyber.
    *   *Grid:* Faint, dark grey lines.
    *   *Lines:* Extremely thin (2px), Neon Cyan/Pink.
    *   *Fill:* NONE. Pure vector look.
    *   *Background:* Pure Black (#000000).

*   **Option C: "The Swiss" (New)**
    *   *Vibe:* Braun / Brutalist Print.
    *   *Grid:* None.
    *   *Lines:* Thick (4px), Solid Black or Red.
    *   *Fill:* Solid low-opacity blocks (no gradients).
    *   *Font:* Bold, contrasting.

**Plan:**

* [x] **Chart Makeover**: Implement selected aesthetic (**Option A: The Field V2**).
    *   [x] Refactor `DecompositionChart` to support variants.
    *   [x] Implement Dot Grid via **Chart.js Plugin** (production-grade, pans/zooms with chart).
    *   [x] Disable old Chart.js grid lines in `ChartCard`.
    *   [x] Add Glow effect plugin to `ChartCard`.
    *   [x] **Migrate `ChartCard` colors from API/theme to Design System tokens.**
* [x] **Bug Fix**: Strange thin vertical line on left side of Chart and Strategy cards.
* [x] **Financials**: Implement detailed cost and savings breakdown.
* [x] **Bug Fix**: Fix Dashboard settings persistence.

---

### [DONE] Rev UI6 â€” Chart Makeover & Financials

**Goal:** Fix critical bugs (Chart Export) and improve system stability (Scheduler Smart Retry).

**Plan:**

* [x] **Fix: Export Chart Visualization**
    *   *Bug:* Historical slots show self-consumption as export.
    *   *Fix:* Update `webapp.py` to stop mapping `battery_discharge` to `export`.
* [x] **Planner Robustness: Persistence & Retry**
    *   *Goal:* Prevent schedule wipes on failure and retry intelligently (smart connectivity check).
    *   *Tasks:* Update `scheduler.py` loop and `pipeline.py` error handling.

---

*All completed revisions have been moved to [CHANGELOG_PLAN.md](CHANGELOG_PLAN.md).*

### [DONE] Rev ARC6 â€” Mega Validation & Merge

**Goal:** Comprehensive end-to-end validation of the entire ARC architecture (FastAPI + React) to prepare for merging the `refactor/arc1-fastapi` branch into `main`.

**Completed:**
* [x] **Full Regression Suite**
    *   Verified 67 API routes (59 OK, 6 Slow, 2 Validated).
    *   Validated WebSocket live metrics.
    *   Verified Frontend Build & Lint (0 errors).
    *   Verified Security (Secrets sanitized).
    *   **Fixed Critical Bug**: Resolved dynamic import crash in `CommandDomains.tsx`.
* [x] **ARC Revision Verification**
    *   Audited ARC1-ARC5 requirements (100% passed).
* [x] **Production Readiness**
    *   Performance: Health (386ms p50), Version (35ms p50).
    *   Tests: 18 files, 178 tests PASSED (Fixed 4 failures).
    *   Linting: Backend (Ruff) & Frontend (ESLint) 100% clean.
    *   OpenAPI: Validated 62 paths.
* [x] **Merge Preparation**
    *   Updated `CHANGELOG.md` with Phase 9.
    *   Version bump to v2.3.0.
