# History Display Investigation - Missing Planned Actions

## Problem Statement
The ChartCard is displaying `actual_soc` (observed battery state) but **NOT** displaying planned action overlays like:
- `target_soc` (planned battery target)
- `charge_kw` / `battery_discharge_kw` (planned charge/discharge actions)
- `reason` (action reasoning text)
- `export_kw` / `water_heating_kw` (other planned actions)

## What Works
‚úÖ History data loads successfully (96 slots)
‚úÖ Race condition fixed - critical path fetching works
‚úÖ `actual_soc` values are present in the data
‚úÖ 188 total slots displayed (96 history + 92 tomorrow)

## What's Broken
‚ùå Planned action fields missing from history slots
‚ùå ChartCard shows only observations, not the planned schedule overlay

## Actual API Response
**Command run:**
```bash
curl -s http://192.168.0.114:5000/api/schedule/today_with_history | jq '.slots[0]'
```

**Output:**
```json
{
  "start_time": "2026-01-13T00:00:00+01:00",
  "end_time": "2026-01-13T01:00:00+01:00",
  "actual_charge_kw": 0.0,
  "actual_discharge_kw": 0.0,
  "actual_export_kwh": 0.0,
  "actual_soc": 27.0,
  "water_heating_kw": 0.0,
  "import_price_sek_kwh": 1.9987875,
  "pv_forecast_kwh": 0.0,
  "load_forecast_kwh": 0.3838405043739117,
  "pv_kwh": 0.0,
  "load_kwh": 0.3838405043739117
}
```

**Analysis:**
- ‚úÖ Has observations: `actual_charge_kw`, `actual_soc`, `actual_export_kwh`
- ‚ùå Missing planned actions: `charge_kw`, `battery_discharge_kw`, `target_soc`
- ‚ùå Missing UI fields: `reason`, `priority`, `is_historical`

## Expected Response
After fix, slots should include planned schedule overlay:
```json
{
  "start_time": "2026-01-13T00:00:00+01:00",
  "end_time": "2026-01-13T01:00:00+01:00",
  
  // Observations (from slot_observations table) ‚úÖ
  "actual_soc": 27.0,
  "actual_charge_kw": 0.0,
  "actual_discharge_kw": 0.0,
  
  // Planned actions (from schedule.json) ‚ùå MISSING
  "target_soc": 45.0,
  "charge_kw": 2.5,
  "battery_discharge_kw": 0.0,
  "export_kw": 0.0,
  "water_heating_kw": 0.0,
  "reason": "Cheap window - strategic charge",
  "priority": 2,
  
  // Prices & forecasts
  "import_price_sek_kwh": 1.9987875,
  "pv_forecast_kwh": 0.0,
  "load_forecast_kwh": 0.3838405043739117
}
```

## Investigation Path

### 1. Check Backend Endpoint Implementation
**File:** `backend/api/routers/services.py`
**Endpoint:** `GET /api/schedule/today_with_history`

**Question:** Does this endpoint merge `schedule.json` (planned) with `slot_observations` (actual)?

**Hypothesis:** The endpoint only queries the `slot_observations` table and does NOT overlay the planned schedule from `schedule.json`.

### 2. Review Slot Observations Query
**File:** `backend/learning/store.py`
**Method:** Likely `get_slot_observations()` or similar

**Question:** Does the query return only observational fields?

**Expected:** The query should:
1. Load observations from `slot_observations` table
2. Load today's planned schedule from `schedule.json`
3. **Merge** them, with planned fields overlaying/augmenting observations

### 3. Check Schedule JSON Structure
**File:** `schedule.json` (generated by planner)
**Location:** Root directory

**Verify:**
```bash
jq '.schedule[0]' schedule.json
```

**Expected fields:**
- `charge_kw`
- `battery_discharge_kw`
- `target_soc`
- `reason`
- `priority`

### 4. Frontend Data Flow
**Files:**
- `frontend/src/pages/Dashboard.tsx` (fetches history)
- `frontend/src/components/ChartCard.tsx` (renders history)

**Current behavior:**
- Frontend correctly receives 96 history slots
- Data includes `actual_soc` ‚úÖ
- Data missing planned overlay fields ‚ùå

**Conclusion:** Frontend is doing its job. Backend is not merging planned schedule.

## Root Cause
The `/api/schedule/today_with_history` endpoint returns **observations only** from the `slot_observations` table. It does NOT merge the planned schedule from `schedule.json`.

## Required Fix
**In `backend/api/routers/services.py`:**

The endpoint needs to:
1. Load observations from DB (current behavior ‚úÖ)
2. Load today's planned schedule from `schedule.json` (missing ‚ùå)
3. Merge them by `start_time`:
   ```python
   for slot in history_slots:
       # Find matching planned slot by start_time
       planned = next((s for s in schedule if s['start_time'] == slot['start_time']), None)
       if planned:
           slot.update({
               'charge_kw': planned.get('charge_kw'),
               'battery_discharge_kw': planned.get('battery_discharge_kw'),
               'target_soc': planned.get('target_soc'),
               'reason': planned.get('reason'),
               'priority': planned.get('priority'),
               'export_kw': planned.get('export_kw'),
               # ... other planned fields
           })
   ```

## Browser Console Evidence
```
üîç [DEBUG] historyData sample slot: 
Object { 
  start_time: "2026-01-13T00:00:00+01:00", 
  actual_soc: 27,
  // NO target_soc, charge_kw, reason, etc.
}
```

## Files to Review
1. `backend/api/routers/services.py` - Endpoint implementation
2. `backend/learning/store.py` - Slot observation queries
3. `schedule.json` - Planned schedule structure
4. `frontend/src/pages/Dashboard.tsx` - Data consumer
5. `frontend/src/components/ChartCard.tsx` - Rendering logic

## Success Criteria
After fix:
- ‚úÖ curl shows `target_soc`, `charge_kw`, `reason` in history slots
- ‚úÖ ChartCard displays green/red action bars
- ‚úÖ Target SoC line overlay visible
- ‚úÖ Reason labels appear on hover
- ‚úÖ Water heating indicators show when applicable

## Previous Context
**Version:** v2.4.10-beta
**Fixed:** Race condition where `historySlots` loaded after `slotsOverride` computation
**Current issue:** History loads early (‚úÖ) but contains incomplete data (‚ùå)
