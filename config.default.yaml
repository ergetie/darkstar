# =============================================================================
# Darkstar Configuration 2.4.8-beta
# =============================================================================
# This is the user's production configuration file.
# Structure matches config.default.yaml with user-specific values.
# =============================================================================

# General System Settings
timezone: "Europe/Stockholm"          # IANA timezone for all schedule calculations

# AI Advisor (Smart Assistant on Dashboard)
advisor:
  enable_llm: true                     # Enable LLM-powered advice on Dashboard
  model: gpt-5-nano                    # OpenRouter model identifier (requires API key in secrets.yaml)
  personality: friendly                # Advice style: concise | friendly | technical
  auto_fetch: false                    # Automatically fetch advice when Dashboard loads

# System Parameters
system:
  system_id: prod
  
  # System Profile Toggles (what hardware do you have?)
  has_solar: true         # Enable PV forecasting & solar-related features
  has_battery: true       # Enable battery control & grid arbitrage
  has_water_heater: true  # Enable water heating optimization
  
  grid:
    max_power_kw: 8                    # HARD limit: max grid import (cannot be exceeded)
  inverter:
    max_power_kw: 8.0                 # Maximum inverter AC power output
  location:
    latitude: 55.493221                # Decimal degrees, positive north (for PV forecasting)
    longitude: 13.111221               # Decimal degrees, positive east (for PV forecasting)
  solar_array:
    azimuth: 150                       # Panel direction: 0°=North, 90°=East, 180°=South, 270°=West
    kwp: 10                            # Total DC peak power of PV array in kilowatts
    tilt: 45                           # Panel angle from horizontal: 0°=flat, 90°=vertical

# Battery Specifications
battery:
  capacity_kwh: 34.2
  min_soc_percent: 12
  max_soc_percent: 100             # Planner target ceiling (BMS still enforces absolute limit)
  max_charge_power_kw: 8
  max_discharge_power_kw: 8
  roundtrip_efficiency_percent: 95.0

battery_economics:
  battery_cycle_cost_kwh: 0.2      # Degradation cost applied per kWh cycled through the battery

# Charging Strategy (when to charge from grid)
charging_strategy:
  charge_threshold_percentile: 15      # Bottom X% of daily prices are considered 'cheap'
  cheap_price_tolerance_sek: 0.05      # Extends 'cheap' window to prices within this tolerance
  price_smoothing_sek_kwh: 0.05        # Groups slots slightly above cheapest into charge window
  block_consolidation_tolerance_sek: 0.05  # Price tolerance for merging adjacent charge blocks
  consolidation_max_gap_slots: 0       # Max gap (in 15-min slots) to bridge when consolidating

# Water Heating
water_heating:
  power_kw: 3.0                    # Power consumption of the water heater
  min_kwh_per_day: 6.0             # Minimum energy to heat per day (usually 2-3h run time)
  defer_up_to_hours: 6             # Allow deferring "today's" heating into early tomorrow morning (up to N hours) if cheaper
  block_start_penalty_sek: 3.0     # Penalty per heating start (higher = more consolidated bulk heating)
  max_hours_between_heating: 8     # Max gap before comfort penalty (only used if enable_top_ups is true)
  comfort_level: 3                 # 1-5 (Economy→Maximum) - controls gap penalty
  min_spacing_hours: 5.0           # Min gap between starts to avoid efficiency loss
  spacing_penalty_sek: 0.20        # Soft penalty for frequent starts
  enable_top_ups: true             # Enable spaced top-up heating blocks (vs bulk heating only)


  # Vacation Mode (anti-legionella)
  vacation_mode:
    enabled: false                    # Master switch (HA entity can override when ON)
    anti_legionella_temp_c: 65        # Target temperature for safety cycle
    anti_legionella_interval_days: 7  # Run cycle every N days
    anti_legionella_duration_hours: 3.0  # Duration at power_kw (e.g., 3h * 3kW = 9kWh)

# S-Index Configuration (Risk & Safety Strategy)
s_index:
  mode: "probabilistic"            # Options: probabilistic | dynamic
  static_factor:                   # Used when mode=static
  base_factor: 1.1                 # Starting point for dynamic calculationsWfz  
  max_factor: 1.5                  # Upper bound clamp for dynamic mode
  pv_deficit_weight: 0.2           # Weight for PV/load deficit contribution
  temp_weight: 0.3                 # Weight for temperature adjustment
  temp_baseline_c: 15.0            # Baseline temperature (no adjustment)
  temp_cold_c: -10.0               # Temperature where adjustment reaches 100%
  s_index_horizon_days: 4          # Number of days ahead to evaluate (integer)
  risk_appetite: 3                 # 1-5 scale (1=safe, 3=neutral, 5=gambler)


# Export Configuration
# [PLACEHOLDER] Most export logic not yet implemented - see backlog
export:
  enable_export: true              # [NOT IMPLEMENTED] Master switch for grid export

# Manual Planning Defaults
manual_planning:
  charge_target_percent: 95        # Cap for manual charge slots
  export_target_percent: 35        # Floor target when manually scheduling export

# Debug & Telemetry (developer settings)
debug:
  enable_planner_debug: false          # Enable verbose planner logging
  sample_size: 30                      # Sample size for debug output charts

# Automation (Background Scheduler)
automation:
  enable_scheduler: true               # Enable automatic schedule regeneration
  schedule:
    every_minutes: 30                  # How often to regenerate schedule
    jitter_minutes: 0                  # Random delay to avoid thundering herd
  ml_training:
    enabled: true                      # Enable automatic ML model retraining
    run_days: [1, 4]                   # Days of week to train (0=Mon, 6=Sun)
    run_time: "03:00"                  # Time of day to run training (HH:MM)

# Learning Engine (Aurora Reflex)
learning:
  enable: true
  sqlite_path: "data/planner_learning.db"
  horizon_days: 7
  min_improvement_threshold: 0.015
  auto_tune_enabled: true
  reflex_enabled: true
  min_sample_threshold: 2
  default_battery_cost_sek_per_kwh: 0.02  # Conservative default until dynamic cost is recorded
  sensor_map: {}
  max_daily_param_change:
    pv_confidence_percent: 1.0
    load_safety_margin_percent: 1.0
    battery_use_margin_sek: 0.02
    export_profit_margin_sek: 0.02
    s_index_base_factor: 0.05
    s_index_pv_deficit_weight: 0.1
    s_index_temp_weight: 0.1
    future_price_guard_buffer_sek: 0.05

# Nordpool API Configuration (electricity prices)
nordpool:
  price_area: "SE4"                    # Nordpool bidding zone (SE1-SE4, NO1-NO5, DK1-DK2, FI, etc.)
  currency: "SEK"                      # Price currency
  resolution_minutes: 15               # Slot resolution (15, 30, or 60)

# Pricing Configuration (your electricity costs)
pricing:
  vat_percent: 25.0                    # VAT percentage on electricity
  grid_transfer_fee_sek: 0.2456        # Grid operator transfer fee per kWh
  energy_tax_sek: 0.439                # Energy tax per kWh
  subscription_fee_sek_per_month: 593.0  # [FUTURE] Fixed monthly grid subscription (for cost analysis)

# Forecasting Adjustments (Aurora ML tuning)
forecasting:
  active_forecast_version: aurora      # Forecast engine: aurora (ML) | legacy
  pv_confidence_percent: 83.0          # PV forecast scaling (100 = trust forecast fully)
  load_safety_margin_percent: 117.0    # Load forecast scaling (>100 = expect more load)

# Grid Limits (Soft Constraint)
# This is a SOFT limit with penalty - planner prefers to stay under but can breach if needed.
# See system.grid.max_power_kw for the HARD limit (cannot be exceeded).
grid:
  import_limit_kw: 11.0                # Soft limit for effekttariff (breached with high penalty)

# Kepler Solver (MILP optimizer settings)
kepler:
  ramping_cost_sek_per_kw: 0.05        # Penalty for power changes between slots (reduces sawtooth)

# =============================================================================
# Home Assistant Integration
# =============================================================================

# Input Sensors (entities Darkstar READS from Home Assistant)
input_sensors:
  # Context sensors for ML features
  alarm_state: alarm_control_panel.alarmo        # Alarm panel for occupancy detection (ML feature)
  vacation_mode: input_boolean.vacation_mode     # Vacation mode toggle (reduces load forecasts)
  
  # Core energy sensors (real-time power)
  battery_soc: sensor.inverter_battery           # Current battery state of charge (%)
  pv_power: sensor.inverter_pv_power             # Current PV production (W or kW)
  load_power: sensor.inverter_load_power         # Current load consumption (W or kW)
  battery_power: sensor.inverter_battery_power   # Current battery power (+ charge, - discharge)
  water_power: sensor.vvb_power                  # Current water heater power (W or kW)
  grid_power: sensor.inverter_grid_power         # Current grid power (+ import, - export)

  # Cumulative energy sensors (totals)
  total_battery_charge: sensor.inverter_total_battery_charge      # Cumulative battery charge (kWh)
  total_battery_discharge: sensor.inverter_total_battery_discharge # Cumulative battery discharge (kWh)
  total_grid_export: sensor.inverter_total_energy_export          # Cumulative grid export (kWh)
  total_grid_import: sensor.inverter_total_energy_import          # Cumulative grid import (kWh)
  total_load_consumption: sensor.inverter_total_load_consumption  # Cumulative load (kWh)
  total_pv_production: sensor.inverter_total_production           # Cumulative PV production (kWh)
  water_heater_consumption: sensor.vvb_energy_daily               # Water heater daily energy (kWh)
  
  # Daily sensors for Dashboard "Today's Stats" card
  today_grid_import: sensor.inverter_today_energy_import          # Today's grid import (kWh)
  today_grid_export: sensor.inverter_today_energy_export          # Today's grid export (kWh)
  today_battery_charge: sensor.inverter_today_battery_charge      # Today's battery charge (kWh)
  today_pv_production: sensor.inverter_today_production           # Today's PV production (kWh)
  today_load_consumption: sensor.inverter_today_load_consumption  # Today's load consumption (kWh)
  today_net_cost: sensor.daily_cost                               # Today's net electricity cost

# Executor (control loop that WRITES to Home Assistant)
executor:
  enabled: true                                  # Enable executor control loop
  shadow_mode: true                              # Log actions but don't execute (for testing)
  interval_seconds: 60                           # How often to run (default: 1 minute)
  pause_reminder_minutes: 30                     # Notify if paused longer than this
  history_retention_days: 30                     # Keep execution history for N days
  
  # Toggle entities (read by executor to check if enabled)
  automation_toggle_entity: input_boolean.darkstar_enable           # Master enable/disable switch
  manual_override_entity: input_boolean.darkstar_manual_override    # Manual override active flag
  soc_target_entity: input_number.master_soc_target                 # SoC target input_number

  # Inverter Control Entities (executor WRITES to these)
  inverter:
    work_mode_entity: select.inverter_work_mode                     # Inverter mode selector
    work_mode_export: "Export First"                                # Value for export mode
    work_mode_zero_export: "Zero Export To CT"                      # Value for zero-export mode
    grid_charging_entity: switch.inverter_battery_grid_charging     # Enable/disable grid charging
    max_charging_current_entity: number.inverter_battery_max_charging_current     # Max charge current (A)
    max_discharging_current_entity: number.inverter_battery_max_discharging_current  # Max discharge current (A)
    grid_max_export_power_entity: number.inverter_export_surplus_power           # Max grid export power (Watts)

  # Controller Parameters (electrical conversion constants)
  controller:
    battery_capacity_kwh: 27.0         # Battery capacity in kWh (for current calculations)
    system_voltage_v: 48.0             # Nominal battery voltage
    worst_case_voltage_v: 46.0         # Minimum voltage for conservative calculations
    inverter_ac_limit_kw: 8.8          # Max AC power output of inverter
    charge_efficiency: 0.92            # Charging efficiency (0-1)
    max_charge_a: 185.0                # Maximum charging current (A)
    max_discharge_a: 185.0             # Maximum discharging current (A)
    min_charge_a: 10.0                 # Minimum meaningful charge current (A)
    round_step_a: 5.0                  # Round current commands to nearest X amps
    write_threshold_a: 5.0             # Only write if change exceeds X amps
    write_threshold_w: 100.0           # Only write power if change exceeds X watts (EEPROM protection)

  # Water Heater Control
  # The executor controls your water heater by setting a target temperature.
  # These temps define the operating modes:
  water_heater:
    target_entity: input_number.vvbtemp  # HA entity to control
    temp_off: 40       # Idle mode (legionella-safe minimum)
    temp_normal: 60    # Scheduled heating target (used by planner)
    temp_boost: 70     # Manual boost button (Dashboard/Executor)
    temp_max: 85       # PV dump target + safety limit (never exceeded)

  # Notifications (via Home Assistant notify service)
  notifications:
    service: notify.mobile_app_sebastians_iphone  # HA notify service to use
    on_charge_start: true              # Notify when grid charging starts
    on_charge_stop: false              # Notify when grid charging stops
    on_export_start: true              # Notify when export/discharge starts
    on_export_stop: true               # Notify when export/discharge stops
    on_water_heat_start: true          # Notify when water heating starts
    on_water_heat_stop: false          # Notify when water heating stops
    on_soc_target_change: false        # Notify when SoC target changes
    on_override_activated: true        # Notify when manual override triggers
    on_error: true                     # Notify on executor errors

# =============================================================================
# UI Settings
# =============================================================================

# Dashboard Settings
dashboard:
  auto_refresh_enabled: true           # Auto-refresh dashboard schedule display
  overlay_defaults: "charge, soctarget, socprojected, water, export, load_off"  # Default chart overlays

# Theme Settings
ui:
  theme: "Material Design Colors"      # Color theme name
  theme_accent_index: 3                # Accent color index (0-based)

# Appliances (for manual scheduling UI)
# Define appliances that can be scheduled in the Planning tab
appliances:
  dishwasher:
    label: Dishwasher                  # Display name in UI
    duration_hours: 1.0                # Typical run duration
  dryer:
    label: Dryer
    duration_hours: 2.0
  washing_machine:
    label: "Washing Machine"
    duration_hours: 2.0
