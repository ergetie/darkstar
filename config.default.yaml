# General System Settings
timezone: "Europe/Stockholm"

advisor:
  enable_llm: false
  model: gpt-5-nano
  personality: concise
  auto_fetch: true

# System Parameters
system:
  grid:
    max_power_kw: 11
  inverter:
    max_power_kw: 10.0
  location:
    latitude: 55.493221 
    longitude: 13.111221
  solar_array:
    azimuth: 150
    kwp: 10
    tilt: 45

# Battery Specifications
battery:
  capacity_kwh: 10.0
  min_soc_percent: 15
  max_soc_percent: 95            # Planner target ceiling (BMS still enforces absolute limit)
  max_charge_power_kw: 5.0
  max_discharge_power_kw: 5.0
  efficiency_percent: 95.0       # Legacy field (maintained for backward compatibility)
  roundtrip_efficiency_percent: 95.0

battery_economics:
  battery_cycle_cost_kwh: 0.20      # Degradation cost applied per kWh cycled through the battery

# Decision Making Thresholds
decision_thresholds:
  battery_use_margin_sek: 0.10      # Use battery if grid > battery_cost + wear + margin
  export_profit_margin_sek: 0.05    # Additional profit required on top of battery cost + wear
  battery_water_margin_sek: 0.20    # Margin for using battery for water heating

# Charging Strategy
charging_strategy:
  charge_threshold_percentile: 15   # Bottom 15% of prices are considered 'cheap'
  cheap_price_tolerance_sek: 0.10   # Extends 'cheap' category to prices within this tolerance
  price_smoothing_sek_kwh: 0.05     # Allows grouping of slots slightly above cheapest price for block planning
  block_consolidation_tolerance_sek: 0.05  # Optional extra tolerance for consolidating charge blocks
  consolidation_max_gap_slots: 0     # Allow bridging up to N zero-capacity slots when consolidating

# Strategic Charging (Floor Price)
strategic_charging:
  price_threshold_sek: 0.90         # Price below which strategic charging is triggered
  target_soc_percent: 95            # Absolute SoC target for strategic charging
  carry_forward_tolerance_ratio: 0.10  # Allow next cheap window if its price within tolerance

# Water Heating
water_heating:
  power_kw: 3.0                     # Power consumption of the water heater
  min_hours_per_day: 2.0            # Minimum run-time per day
  min_kwh_per_day: 6.0              # Optional; defaults to power * hours when unset
  max_blocks_per_day: 2             # Prefer single block, up to two if needed
  schedule_future_only: true        # Only schedule future slots (skip current slot)
  defer_up_to_hours: 3              # Allow deferring into early tomorrow up to N hours if cheaper
  plan_days_ahead: 1                # Plan at most today + 1 day (tomorrow) within 48h horizon
  block_consolidation_tolerance_sek: 0.05
  consolidation_max_gap_slots: 0

# S-Index Configuration
s_index:
  mode: "probabilistic"              # Options: probabilistic | dynamic
  static_factor: 1.05               # Used when mode=static
  base_factor: 1.05                 # Starting point for dynamic calculations
  max_factor: 1.50                  # Upper bound clamp for dynamic mode
  pv_deficit_weight: 0.30           # Weight for PV/load deficit contribution
  temp_weight: 0.20                 # Weight for temperature adjustment
  temp_baseline_c: 20               # Baseline temperature (no adjustment)
  temp_cold_c: -15                  # Temperature where adjustment reaches 100%
  s_index_horizon_days: 4           # Number of days ahead to evaluate (integer)
  risk_appetite: 3                  # 1-5 scale (1=safe, 3=neutral, 5=gambler)
  soc_scaling_factor: 250           # Converts risk_factor to target SoC %

# Smoothing / Hysteresis Controls
smoothing:
  min_on_slots_charge: 2
  min_off_slots_charge: 1
  min_on_slots_discharge: 2
  min_off_slots_discharge: 1
  min_on_slots_export: 2
  charge_power_step_kw: 0.5
  charge_power_dwell_minutes: 0

# Arbitrage / Export Settings
arbitrage:
  enable_export: true
  export_fees_sek_per_kwh: 0.0
  export_profit_margin_sek: 0.05
  protective_soc_strategy: "gap_based"
  fixed_protective_soc_percent: 15.0
  export_percentile_threshold: 15        # Top X% of prices eligible for export
  enable_peak_only_export: true
  export_future_price_guard: true
  future_price_guard_buffer_sek: 0.00

# Manual Planning Defaults
manual_planning:
  charge_target_percent: 95              # Cap for manual charge slots
  export_target_percent: 35              # Floor target when manually scheduling export
  override_hold_in_cheap: true           # Ignore cheap-window hold while simulating manual plan
  force_discharge_on_deficit: true       # If deficit, allow discharge even if price/cheap guards would block
  ignore_protective_guard: true          # Do not raise SoC target floor above min_soc during manual plan

# Debug & Telemetry
debug:
  enable_planner_debug: false
  sample_size: 30

# Automation (Scheduler + DB writer)
automation:
  enable_scheduler: false
  write_to_mariadb: false
  schedule:
    every_minutes: 60
    jitter_minutes: 0

# Learning Engine
learning:
  enable: true
  sqlite_path: "data/planner_learning.db"
  sync_interval_minutes: 5
  horizon_days: 7
  min_improvement_threshold: 0.015
  auto_apply: true
  min_sample_threshold: 36
  default_battery_cost_sek_per_kwh: 0.20
  sensor_map: {}
  max_daily_param_change:
    pv_confidence_percent: 1.0
    load_safety_margin_percent: 1.0
    battery_use_margin_sek: 0.02
    export_profit_margin_sek: 0.02
    s_index_base_factor: 0.05
    s_index_pv_deficit_weight: 0.05
    s_index_temp_weight: 0.05
    future_price_guard_buffer_sek: 0.05

# Nordpool API Configuration
nordpool:
  price_area: "SE4"
  currency: "SEK"
  resolution_minutes: 15

# Pricing Configuration
pricing:
  vat_percent: 25.0
  grid_transfer_fee_sek: 0.2456
  energy_tax_sek: 0.439

# Forecasting Adjustments
forecasting:
  pv_confidence_percent: 90.0
  load_safety_margin_percent: 110.0
