<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Helios Energy Schedule</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <link href="https://cdn.jsdelivr.net/npm/vis-timeline@7.7.3/styles/vis-timeline-graph2d.min.css" rel="stylesheet" type="text/css" />
    <script src="https://cdn.jsdelivr.net/npm/vis-timeline@7.7.3/standalone/umd/vis-timeline-graph2d.min.js"></script>
</head>
<body>
    <header>
        <nav class="tabs">
            <button class="tab-button active" data-tab="dashboard">Dashboard</button>
            <button class="tab-button" data-tab="settings">Settings</button>
            <button class="tab-button" data-tab="learning">Learning</button>
            <button class="tab-button" data-tab="debug">Debug</button>
            <button class="tab-button" data-tab="system">System</button>
        </nav>
    </header>
    <main>
        <pre id="ascii-logo">
█▀▄ ▄▀█ █▀█ █▄▀ █▀ ▀█▀ ▄▀█ █▀█
█▄▀ █▀█ █▀▄ █░█ ▄█ ░█░ █▀█ █▀▄
        </pre>
        <div class="subtitle">energy manager v0.1</div>
        <div id="dashboard" class="tab-content active">
            <div class="stats-group">
              <fieldset class="stats-box">
                <legend>Stats</legend>
                <div id="stats-content">
                  <!-- This will be populated by JavaScript -->
                </div>
              </fieldset>
            </div>
            <canvas id="scheduleChart"></canvas>
            <div id="timeline-container"></div>
            <div class="timeline-controls">
                <button id="addChargeBtn" class="action-add btn-charge">> add charge</button>
                <button id="addWaterBtn" class="action-add btn-water">> add water heating</button>
                <button id="addHoldBtn" class="action-add btn-hold">> add hold</button>
                <button id="addExportBtn" class="action-add btn-export">> add export</button>
            </div>
            <div class="control-panel">
                <button id="runPlannerBtn">> run planner</button>
                <button id="reloadServerBtn">> load server plan</button>
                <button id="pushDbBtn">> push to db</button>
                <button id="applyChangesBtn">> apply manual changes</button>
                <button id="resetChangesBtn">> reset to optimal</button>
                <span id="plannerStatus"></span>
            </div>
        </div>
        <div id="settings" class="tab-content">
            <form id="settings-form">
                <fieldset>
                    <legend>Decision Thresholds</legend>
                    <label>Battery Use Margin (SEK): <input type="number" step="0.01" name="decision_thresholds.battery_use_margin_sek"></label>
                    <label>Export Profit Margin (SEK): <input type="number" step="0.01" name="decision_thresholds.export_profit_margin_sek"></label>
                    <label>Battery Water Margin (SEK): <input type="number" step="0.01" name="decision_thresholds.battery_water_margin_sek"></label>
                </fieldset>
                <fieldset>
                    <legend>Battery Economics</legend>
                    <label>Cycle Cost (SEK/kWh): <input type="number" step="0.01" name="battery_economics.battery_cycle_cost_kwh"></label>
                    <label>Round-trip Efficiency (%): <input type="number" step="0.1" name="battery.roundtrip_efficiency_percent"></label>
                </fieldset>
                <fieldset>
                    <legend>Charging Strategy</legend>
                    <label>Cheap Percentile (%): <input type="number" step="1" name="charging_strategy.charge_threshold_percentile"></label>
                    <label>Cheap Price Tolerance (SEK): <input type="number" step="0.01" name="charging_strategy.cheap_price_tolerance_sek"></label>
                    <label>Price Smoothing (SEK/kWh): <input type="number" step="0.01" name="charging_strategy.price_smoothing_sek_kwh"></label>
                </fieldset>
                <fieldset>
                    <legend>Strategic Charging</legend>
                    <label>Price Threshold (SEK): <input type="number" step="0.01" name="strategic_charging.price_threshold_sek"></label>
                    <label>Target SoC (%): <input type="number" name="strategic_charging.target_soc_percent"></label>
                    <label>Carry-forward Tolerance Ratio: <input type="number" step="0.01" name="strategic_charging.carry_forward_tolerance_ratio"></label>
                </fieldset>
                <fieldset>
                    <legend>S-Index Safety</legend>
                    <label>Mode:
                        <select name="s_index.mode">
                            <option value="static">static</option>
                            <option value="dynamic">dynamic</option>
                        </select>
                    </label>
                    <label>Static Factor: <input type="number" step="0.01" name="s_index.static_factor"></label>
                    <label>Base Factor: <input type="number" step="0.01" name="s_index.base_factor"></label>
                    <label>Max Factor: <input type="number" step="0.01" name="s_index.max_factor"></label>
                    <label>PV Deficit Weight: <input type="number" step="0.01" name="s_index.pv_deficit_weight"></label>
                    <label>Temperature Weight: <input type="number" step="0.01" name="s_index.temp_weight"></label>
                    <label>Temp Baseline (°C): <input type="number" step="0.1" name="s_index.temp_baseline_c"></label>
                    <label>Temp Cold (°C): <input type="number" step="0.1" name="s_index.temp_cold_c"></label>
                    <label>Days Ahead (comma-separated): <input type="text" name="s_index.days_ahead_for_sindex"></label>
                </fieldset>
                <fieldset>
                    <legend>Water Heating</legend>
                    <label>Power (kW): <input type="number" step="0.1" name="water_heating.power_kw"></label>
                    <label>Min Hours/Day: <input type="number" step="0.1" name="water_heating.min_hours_per_day"></label>
                    <label>Min kWh/Day: <input type="number" step="0.1" name="water_heating.min_kwh_per_day"></label>
                    <label>Max Blocks/Day: <input type="number" step="1" name="water_heating.max_blocks_per_day"></label>
                    <label>
                        <input type="checkbox" name="water_heating.schedule_future_only">
                        Schedule Future Slots Only
                    </label>
                </fieldset>
                <fieldset>
                    <legend>Arbitrage &amp; Export</legend>
                    <label>
                        <input type="checkbox" name="arbitrage.enable_export">
                        Enable Export
                    </label>
                    <label>Export Fees (SEK/kWh): <input type="number" step="0.01" name="arbitrage.export_fees_sek_per_kwh"></label>
                    <label>Export Profit Margin (SEK): <input type="number" step="0.01" name="arbitrage.export_profit_margin_sek"></label>
                    <label>Export Percentile Threshold (%): <input type="number" step="1" name="arbitrage.export_percentile_threshold"></label>
                    <label>Protective Strategy:
                        <select name="arbitrage.protective_soc_strategy">
                            <option value="gap_based">gap_based</option>
                            <option value="fixed">fixed</option>
                        </select>
                    </label>
                    <label>Fixed Protective SoC (%): <input type="number" step="0.1" name="arbitrage.fixed_protective_soc_percent"></label>
                    <label>
                        <input type="checkbox" name="arbitrage.enable_peak_only_export">
                        Peak-only Export
                    </label>
                    <label>
                        <input type="checkbox" name="arbitrage.export_future_price_guard">
                        Future Price Guard
                    </label>
                    <label>Future Price Guard Buffer (SEK): <input type="number" step="0.01" name="arbitrage.future_price_guard_buffer_sek"></label>
                </fieldset>
                <fieldset>
                    <legend>Smoothing / Hysteresis</legend>
                    <label>Min On Slots (Charge): <input type="number" step="1" name="smoothing.min_on_slots_charge"></label>
                    <label>Min Off Slots (Charge): <input type="number" step="1" name="smoothing.min_off_slots_charge"></label>
                    <label>Min On Slots (Discharge): <input type="number" step="1" name="smoothing.min_on_slots_discharge"></label>
                    <label>Min Off Slots (Discharge): <input type="number" step="1" name="smoothing.min_off_slots_discharge"></label>
                    <label>Min On Slots (Export): <input type="number" step="1" name="smoothing.min_on_slots_export"></label>
                </fieldset>
                <fieldset>
                    <legend>Pricing</legend>
                    <label>VAT (%): <input type="number" step="0.1" name="pricing.vat_percent"></label>
                    <label>Grid Transfer Fee (SEK): <input type="number" step="0.0001" name="pricing.grid_transfer_fee_sek"></label>
                    <label>Energy Tax (SEK): <input type="number" step="0.001" name="pricing.energy_tax_sek"></label>
                </fieldset>
                <fieldset>
                    <legend>Nordpool Settings</legend>
                    <label>Price Area: <input type="text" name="nordpool.price_area"></label>
                    <label>Currency: <input type="text" name="nordpool.currency"></label>
                    <label>Resolution (minutes): <input type="number" name="nordpool.resolution_minutes"></label>
                </fieldset>
                <fieldset>
                    <legend>Debug &amp; Telemetry</legend>
                    <label>
                        <input type="checkbox" name="debug.enable_planner_debug">
                        Enable Planner Debug
                    </label>
                    <label>Debug Sample Size: <input type="number" step="1" name="debug.sample_size"></label>
                    <label>
                        <input type="checkbox" name="learning.enable">
                        Enable Learning Telemetry
                    </label>
                    <label>SQLite Path: <input type="text" name="learning.sqlite_path"></label>
                    <label>Sync Interval (minutes): <input type="number" step="1" name="learning.sync_interval_minutes"></label>
                    <label>Horizon Days: <input type="number" step="1" name="learning.horizon_days"></label>
                    <label>Min Improvement Threshold: <input type="number" step="0.001" name="learning.min_improvement_threshold"></label>
                    <label>
                        <input type="checkbox" name="learning.auto_apply">
                        Auto-apply Changes
                    </label>
                </fieldset>
                <fieldset>
                    <legend>Learning Parameter Limits</legend>
                    <label>PV Confidence Daily Change (%): <input type="number" step="0.1" name="learning.max_daily_param_change.pv_confidence_percent"></label>
                    <label>Load Safety Margin Daily Change (%): <input type="number" step="0.1" name="learning.max_daily_param_change.load_safety_margin_percent"></label>
                    <label>Battery Use Margin Daily Change (SEK): <input type="number" step="0.001" name="learning.max_daily_param_change.battery_use_margin_sek"></label>
                    <label>Export Profit Margin Daily Change (SEK): <input type="number" step="0.001" name="learning.max_daily_param_change.export_profit_margin_sek"></label>
                    <label>S-index Base Factor Daily Change: <input type="number" step="0.001" name="learning.max_daily_param_change.s_index_base_factor"></label>
                    <label>S-index PV Deficit Weight Daily Change: <input type="number" step="0.001" name="learning.max_daily_param_change.s_index_pv_deficit_weight"></label>
                    <label>S-index Temperature Weight Daily Change: <input type="number" step="0.001" name="learning.max_daily_param_change.s_index_temp_weight"></label>
                    <label>Export Guard Buffer Daily Change (SEK): <input type="number" step="0.001" name="learning.max_daily_param_change.future_price_guard_buffer_sek"></label>
                </fieldset>
                <fieldset>
                    <legend>Automation</legend>
                    <label>
                        <input type="checkbox" name="automation.enable_scheduler">
                        enable automatic planner (08–22)
                    </label>
                    <label>
                        <input type="checkbox" name="automation.write_to_mariadb">
                        write schedules to mariadb
                    </label>
                </fieldset>
                <fieldset>
                    <legend>Manual Planning</legend>
                    <label>Charge Target (%):
                        <input type="number" step="1" min="0" max="100" name="manual_planning.charge_target_percent">
                    </label>
                    <label>Export Target (%):
                        <input type="number" step="1" min="0" max="100" name="manual_planning.export_target_percent">
                    </label>
                    <label>
                        <input type="checkbox" name="manual_planning.override_hold_in_cheap">
                        override hold in cheap windows (manual apply)
                    </label>
                    <label>
                        <input type="checkbox" name="manual_planning.force_discharge_on_deficit">
                        force discharge on deficit (manual apply)
                    </label>
                    <label>
                        <input type="checkbox" name="manual_planning.ignore_protective_guard">
                        ignore protective target guard (manual apply)
                    </label>
                </fieldset>
                <fieldset>
                    <legend>Appearance</legend>
                    <label>Theme:
                        <select id="themeSelect">
                            <!-- Populated dynamically -->
                        </select>
                    </label>
                    <label>Main color index:
                        <select id="themeAccentSelect">
                            <!-- Populated dynamically -->
                        </select>
                    </label>
                    <input type="hidden" name="ui.theme_accent_index" id="themeAccentInput" value="">
                </fieldset>
            </form>
            <div class="actions">
                <button id="save-changes">Save Changes</button>
                <button id="reset-defaults">Reset to Defaults</button>
            </div>
        </div>
        <div id="system" class="tab-content">
            <form id="system-form">
                <fieldset>
                    <legend>Battery</legend>
                    <label>Capacity (kWh): <input type="number" step="0.1" name="system.battery.capacity_kwh"></label>
                    <label>Max Charge Power (kW): <input type="number" step="0.1" name="system.battery.max_charge_power_kw"></label>
                    <label>Max Discharge Power (kW): <input type="number" step="0.1" name="system.battery.max_discharge_power_kw"></label>
                    <label>Min SoC (%): <input type="number" step="0.1" name="system.battery.min_soc_percent"></label>
                    <label>Max SoC (%): <input type="number" step="0.1" name="system.battery.max_soc_percent"></label>
                </fieldset>
                <fieldset>
                    <legend>Location</legend>
                    <label>Latitude: <input type="number" step="0.0001" name="system.location.latitude"></label>
                    <label>Longitude: <input type="number" step="0.0001" name="system.location.longitude"></label>
                </fieldset>
                <fieldset>
                    <legend>Solar Array</legend>
                    <label>KWp: <input type="number" step="0.1" name="system.solar_array.kwp"></label>
                    <label>Azimuth: <input type="number" name="system.solar_array.azimuth"></label>
                    <label>Tilt: <input type="number" name="system.solar_array.tilt"></label>
                </fieldset>
                <fieldset>
                    <legend>Inverter</legend>
                    <label>Max Power (kW): <input type="number" step="0.1" name="system.inverter.max_power_kw"></label>
                </fieldset>
                <fieldset>
                    <legend>Grid</legend>
                    <label>Max Power (kW): <input type="number" step="0.1" name="system.grid.max_power_kw"></label>
                </fieldset>
            </form>
            <div class="actions">
                <button id="save-changes">Save Changes</button>
                <button id="reset-defaults">Reset to Defaults</button>
            </div>
        </div>
        <div id="learning" class="tab-content">
            <div class="learning-dashboard">
                <fieldset class="learning-status">
                    <legend>Learning Engine Status</legend>
                    <div id="learning-status-content">
                        <!-- Populated by JavaScript -->
                    </div>
                </fieldset>
                
                <fieldset class="learning-metrics">
                    <legend>Performance Metrics</legend>
                    <div id="learning-metrics-content">
                        <!-- Populated by JavaScript -->
                    </div>
                </fieldset>
                
                <fieldset class="learning-loops">
                    <legend>Learning Loops Status</legend>
                    <div id="learning-loops-content">
                        <!-- Populated by JavaScript -->
                    </div>
                </fieldset>
                
                <fieldset class="learning-changes">
                    <legend>Recent Configuration Changes</legend>
                    <div id="learning-changes-content">
                        <!-- Populated by JavaScript -->
                    </div>
                </fieldset>
                
                <div class="learning-controls">
                    <button id="run-learning-btn">> Run Learning Now</button>
                    <button id="refresh-learning-btn">> Refresh Status</button>
                    <span id="learning-run-status"></span>
                </div>
            </div>
        </div>
        <div id="debug" class="tab-content">
            <div class="debug-dashboard">
                <fieldset class="debug-metrics">
                    <legend>Planner Metrics</legend>
                    <div id="debug-metrics-content">
                        <!-- Populated by JavaScript -->
                    </div>
                </fieldset>
                
                <fieldset class="debug-charging">
                    <legend>Charging Plan Analysis</legend>
                    <div id="debug-charging-content">
                        <!-- Populated by JavaScript -->
                    </div>
                </fieldset>
                
                <fieldset class="debug-sindex">
                    <legend>S-Index Calculations</legend>
                    <div id="debug-sindex-content">
                        <!-- Populated by JavaScript -->
                    </div>
                </fieldset>
                
                <fieldset class="debug-windows">
                    <legend>Price Windows Analysis</legend>
                    <div id="debug-windows-content">
                        <!-- Populated by JavaScript -->
                    </div>
                </fieldset>
                
                <fieldset class="debug-export">
                    <legend>Export Guard Analysis</legend>
                    <div id="debug-export-content">
                        <!-- Populated by JavaScript -->
                    </div>
                </fieldset>
                
                <fieldset class="debug-etl">
                    <legend>ETL Status</legend>
                    <div id="debug-etl-content">
                        <!-- Populated by JavaScript -->
                    </div>
                </fieldset>
                
                <fieldset class="debug-samples">
                    <legend>Debug Samples</legend>
                    <div id="debug-samples-content">
                        <!-- Populated by JavaScript -->
                    </div>
                </fieldset>
                
                <div class="debug-controls">
                    <button id="refresh-debug-btn">> Refresh Debug Data</button>
                    <span id="debug-refresh-status"></span>
                </div>
            </div>
        </div>
    </main>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="/static/js/app.js"></script>
</body>
</html>
