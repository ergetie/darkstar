advisor:
  # Auto-fetch: If true, the advisor runs automatically on schedule.
  auto_fetch: false
  # Enable LLM: Master switch for the AI Advisor feature.
  enable_llm: true
  # Model: The LLM model to use (e.g., gpt-4, gpt-5-nano).
  model: gpt-5-nano
  # Personality: The persona adopted by the AI Advisor.
  personality: friendly

appliances:
  # Appliance definitions for "The Analyst" to suggest run times.
  dishwasher:
    duration_hours: 1.0
    label: Dishwasher
  dryer:
    duration_hours: 2.0
    label: Dryer
  washing_machine:
    duration_hours: 2.0
    label: Washing Machine

arbitrage:
  # (Legacy MPC) Enable Export: If false, export is disabled.
  # Note: Kepler currently ignores this and uses system.grid.max_power_kw.
  enable_export: true
  # (Legacy MPC) Peak Only: Only export during price peaks.
  enable_peak_only_export: true
  # (Legacy MPC) Export Fees: Additional cost per kWh exported.
  export_fees_sek_per_kwh: 0.0
  # (Legacy MPC) Future Price Guard: Prevent export if future prices are significantly higher.
  export_future_price_guard: true
  # (Legacy MPC) Percentile Threshold: Only export if price is in top X percentile.
  export_percentile_threshold: 15
  # (Legacy MPC) Profit Margin: Minimum profit required to export.
  export_profit_margin_sek: 0.05
  # (Legacy MPC) Fixed Protective SoC: Minimum SoC to keep during export.
  fixed_protective_soc_percent: 10.0
  # (Legacy MPC) Future Price Guard Buffer: Extra buffer for price guard.
  future_price_guard_buffer_sek: 0.0
  # (Legacy MPC) Protective Strategy: 'gap_based' or 'fixed_protective_soc_percent'.
  protective_soc_strategy: gap_based

automation:
  # Enable Scheduler: Master switch for the internal scheduler loop.
  enable_scheduler: true
  schedule:
    # Every Minutes: How often the planner runs.
    every_minutes: 60
    # Jitter: Random delay to avoid thundering herd.
    jitter_minutes: 0
  # Write to MariaDB: Persist schedule to external database.
  write_to_mariadb: false

battery:
  # Capacity: Total battery energy in kWh.
  capacity_kwh: 34.2
  # Max Charge Power: Maximum charging rate in kW.
  max_charge_power_kw: 8
  # Max Discharge Power: Maximum discharging rate in kW.
  max_discharge_power_kw: 8
  # Max SoC: Maximum allowed State of Charge (%).
  max_soc_percent: 100
  # Min SoC: Minimum allowed State of Charge (%).
  min_soc_percent: 12
  # Roundtrip Efficiency: Combined charge/discharge efficiency (%).
  roundtrip_efficiency_percent: 95.0

battery_economics:
  # Cycle Cost: Estimated cost of battery wear per kWh cycled.
  battery_cycle_cost_kwh: 0.2

charging_strategy:
  # (Legacy MPC) Block Consolidation: Merge charge blocks if price diff is within this tolerance.
  block_consolidation_tolerance_sek: 0.05
  # (Legacy MPC) Charge Threshold: Charge if price is in bottom X percentile.
  charge_threshold_percentile: 15
  # Cheap Price Tolerance: Used by Pass 1 (Windows) and Water Heating.
  # Defines "Cheap" as min_price + tolerance.
  cheap_price_tolerance_sek: 0.05
  # (Legacy MPC) Consolidation Gap: Max slots to bridge between charge blocks.
  consolidation_max_gap_slots: 0
  # (Legacy MPC) Price Smoothing: Hysteresis for price thresholds.
  price_smoothing_sek_kwh: 0.05

dashboard:
  # Auto Refresh: Enable live updates in the UI.
  auto_refresh_enabled: true
  # Overlay Defaults: Default layers enabled on the chart.
  overlay_defaults: charge, soctarget, socprojected, water, export, load_off

debug:
  # Enable Planner Debug: Generate detailed debug payloads.
  enable_planner_debug: true
  # Sample Size: Number of slots to include in debug sample.
  sample_size: 30

decision_thresholds:
  # (Legacy MPC) Battery Use Margin: Min savings required to use battery vs grid.
  battery_use_margin_sek: 0.1
  # (Legacy MPC) Battery Water Margin: Min savings to use battery for water heating.
  battery_water_margin_sek: 0.2
  # (Legacy MPC) Export Profit Margin: Min profit to export.
  export_profit_margin_sek: 0.05

forecasting:
  # Active Forecast: 'aurora' (ML) or 'baseline' (Average).
  active_forecast_version: aurora
  # (Legacy MPC) Load Safety Margin: Static multiplier for load (replaced by S-Index).
  load_safety_margin_percent: 117.0
  # PV Confidence: Confidence interval for PV forecast (lower bound).
  pv_confidence_percent: 83.0

input_sensors:
  # Map internal sensor names to Home Assistant Entity IDs.
  alarm_state: alarm_control_panel.alarmo
  battery_soc: sensor.inverter_battery
  total_battery_charge: sensor.inverter_total_battery_charge
  total_battery_discharge: sensor.inverter_total_battery_discharge
  total_grid_export: sensor.inverter_total_energy_export
  total_grid_import: sensor.inverter_total_energy_import
  total_load_consumption: sensor.inverter_total_load_consumption
  total_pv_production: sensor.inverter_total_production
  vacation_mode: input_boolean.vacation_mode
  water_heater_consumption: sensor.vvb_energy_daily

kepler:
  # Enabled: Enable the Kepler MILP solver.
  enabled: true
  # Primary Planner: Use Kepler as the main planner (replaces Legacy MPC).
  primary_planner: true
  # Shadow Mode: Run Kepler in background for comparison (if primary is false).
  shadow_mode: true

learning:
  # Auto Apply: Automatically apply learned parametlearning:
  enable: true
  sqlite_path: "data/planner_learning.db"
  # Auto-Tune: Automatically adjust planner parameters based on historical bias.
  auto_tune_enabled: false
  # Default battery wear cost if not learned/overridden
  default_battery_cost_sek_per_kwh: 0.02
  # Enable: Enable the Aurora Learning Engine.
  enable: true
  # Horizon: Days of history to use for learning.
  horizon_days: 7
  # Max Daily Change: Limits on how much parameters can change per day.
  max_daily_param_change:
    battery_use_margin_sek: 0.02
    export_profit_margin_sek: 0.02
    future_price_guard_buffer_sek: 0.05
    load_safety_margin_percent: 1.0
    pv_confidence_percent: 1.0
    s_index_base_factor: 0.05
    s_index_pv_deficit_weight: 0.1
    s_index_temp_weight: 0.1
  # Min Improvement: Min metric improvement to accept a new parameter set.
  min_improvement_threshold: 0.015
  # Min Sample: Min days of data required.
  min_sample_threshold: 2
  # Sensor Map: Custom sensor mapping for learning (optional).
  sensor_map: {}
  # SQLite Path: Path to the learning database.
  sqlite_path: data/planner_learning.db
  # Sync Interval: How often to sync data.
  sync_interval_minutes: 5

manual_planning:
  # Charge Target: SoC target for manual "Charge" blocks.
  charge_target_percent: 95
  # Export Target: SoC target (floor) for manual "Export" blocks.
  export_target_percent: 35
  # Force Discharge: Allow discharge even if protective guard is active.
  force_discharge_on_deficit: true
  # Ignore Protective Guard: Bypass protective SoC for manual actions.
  ignore_protective_guard: true
  # Override Hold: Allow manual actions to override "Hold" logic.
  override_hold_in_cheap: true

nordpool:
  # Currency: Market currency.
  currency: SEK
  # Price Area: Nordpool price area (e.g., SE3, SE4).
  price_area: SE4
  # Resolution: Data resolution in minutes (15 or 60).
  resolution_minutes: 15

grid:
  # Maximum allowed grid import power in kW (e.g., main fuse limit or tariff tier)
  # 11.0 kW ~= 16A * 230V * 3 phases
  import_limit_kw: 11.0

pricing:
  # Energy Tax: Fixed tax per kWh (SEK).
  energy_tax_sek: 0.439
  # Grid Transfer Fee: Variable grid fee per kWh (SEK).
  grid_transfer_fee_sek: 0.2456
  # VAT: Value Added Tax (%).
  vat_percent: 25.0
  # Subscription Fee: Fixed monthly cost (SEK).
  subscription_fee_sek_per_month: 593.0

s_index:
  # Base Factor: The starting multiplier for load (Inflated Demand).
  # 1.0 = No inflation. 1.5 = Plan for 150% load.
  base_factor: 1.1
  
  # Days Ahead: How many days into the future to check for risk.
  s_index_horizon_days: 4
  
  # Max Factor: The absolute cap on load inflation.
  max_factor: 1.5
  
  # Mode: 'dynamic' uses PV/Temp to adjust factor. 'static' uses base_factor only.
  mode: dynamic
  
  # Weights: How much D2/D3 conditions affect the S-Index.
  pv_deficit_weight: 0.2
  temp_weight: 0.3 # Reduced from 0.5
  
  # Temperature Baseline: Below this temp, risk increases.
  temp_baseline_c: 15.0
  temp_cold_c: -10.0
  
  # SoC Scaling: How much S-Index increases the Target SoC buffer.
  # Target % = Min % + (S-Index - 1.0) * Scaling
  soc_scaling_factor: 50.0

smoothing:
  # (Legacy MPC) Dwell Minutes: Min duration for charge power changes.
  charge_power_dwell_minutes: 0
  # (Legacy MPC) Step kW: Quantization step for charge power.
  charge_power_step_kw: 0.5
  # (Legacy MPC) Min Off Slots: Min gap between charge blocks.
  min_off_slots_charge: 1
  # (Legacy MPC) Min Off Slots: Min gap between discharge blocks.
  min_off_slots_discharge: 1
  # (Legacy MPC) Min On Slots: Min duration of charge blocks.
  min_on_slots_charge: 2
  # (Legacy MPC) Min On Slots: Min duration of discharge blocks.
  min_on_slots_discharge: 2
  # (Legacy MPC) Min On Slots: Min duration of export blocks.
  min_on_slots_export: 2

strategic_charging:
  # (Legacy MPC) Carry Forward: Tolerance for carrying energy to future windows.
  carry_forward_tolerance_ratio: 0.05
  # (Legacy MPC) Price Threshold: Price below which to consider strategic charging.
  price_threshold_sek: 0.85
  # Target SoC: Used by Dynamic S-Index to set the strategic buffer.
  target_soc_percent: 80

system:
  grid:
    # Max Power: Grid connection limit in kW.
    max_power_kw: 8
  inverter:
    # Max Power: Inverter capacity in kW.
    max_power_kw: 10.0
  location:
    # Latitude/Longitude: Used for weather and PV forecasts.
    latitude: 55.493221
    longitude: 13.111221
  solar_array:
    # Solar Array Specs: Used for PV forecasting.
    azimuth: 150
    kwp: 10
    tilt: 45
  system_id: dev

timezone: Europe/Stockholm

ui:
  theme: Material Design Colors
  theme_accent_index: 3

water_heating:
  # Block Consolidation: Merge water blocks if price diff is within this tolerance.
  block_consolidation_tolerance_sek: 0.05
  # Consolidation Gap: Max slots to bridge between water blocks.
  consolidation_max_gap_slots: 0
  # Defer Up To: Max hours to delay water heating.
  defer_up_to_hours: 6
  # Max Blocks: Max number of contiguous water heating blocks per day.
  max_blocks_per_day: 2
  # Min Hours: Minimum hours of water heating per day.
  min_hours_per_day: 2.0
  # Min kWh: Minimum energy for water heating per day.
  min_kwh_per_day: 6.0
  # Plan Days Ahead: How far ahead to schedule water heating.
  plan_days_ahead: 1
  # Power: Power consumption of the water heater in kW.
  power_kw: 3.0
  # Schedule Future Only: If true, only schedule slots in the future.
  schedule_future_only: true
